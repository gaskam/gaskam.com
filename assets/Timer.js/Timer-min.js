// Version 1.0.0 Beta - Gaskam.dev - Â©2022 Gaskam.dev BSD 3-Clause License - All rights reserved
export class Timer{beginTime=null;pauseAmount=0;pauseBegin=null;paused=!0;callbacks=[];_timeline=[];specialEventsRegistry=[];_currentTimeoutId=-1;options={eventPrecision:0};now(){return Date.now()}formatTime(b,a){if("ms"===(a=(a=a||"ms").toLowerCase()))return b;if(a.includes("yyyy")){let i=Math.floor(b/31536e6);a=a.replace("yyyy",i),b-=31536e6*i}else if(a.includes("yy")){let j=Math.floor(b/31536e6);a=a.replace("yy",String(j).slice(-2)),b-=31536e6*j}if(a.includes("mo")){let d=Math.floor(b/2592e6);d<10&&(d="0"+d),a=a.replace("mo",d),b-=2592e6*d}if(a.includes("ww")){let k=Math.floor(b/6048e5);a=a.replace("ww",k),b-=6048e5*k}if(a.includes("dd")){let e=Math.floor(b/864e5);e<10&&(e="0"+e),a=a.replace("dd",e),b-=864e5*e}if(a.includes("hh")){let f=Math.floor(b/36e5);f<10&&(f="0"+f),a=a.replace("hh",f),b-=36e5*f}if(a.includes("mm")){let g=Math.floor(b/6e4);g<10&&(g="0"+g),a=a.replace("mm",g),b-=6e4*g}if(a.includes("ss")){let h=Math.floor(b/1e3);h<10&&(h="0"+h),a=a.replace("ss",h),b-=1e3*h}if(a.includes("ms")){let c=Math.floor(b);c<100?c="00"+c:c<10&&(c="0"+c),a=a.replace("ms",c)}return a}toMs(a){try{if("string"==typeof a){if((a=a.toLowerCase()).includes("ms"))return Number(a.replace("ms",""));if(a.includes("ss"))return 1e3*Number(a.replace("ss",""));if(a.includes("mm"))return 6e4*Number(a.replace("mm",""));if(a.includes("hh"))return 36e5*Number(a.replace("hh",""));if(a.includes("dd"))return 864e5*Number(a.replace("dd",""));if(a.includes("ww"))return 6048e5*Number(a.replace("ww",""));if(a.includes("mo"))return 2592e6*Number(a.replace("mo",""));if(a.includes("yyyy"))return 31536e6*Number(a.replace("yyyy",""));if(a.includes("yy"))return 31536e6*Number(a.replace("yy",""));if(a.includes("s"))return 1e3*Number(a.replace("s",""));if(a.includes("m"))return 6e4*Number(a.replace("m",""));if(a.includes("h"))return 36e5*Number(a.replace("h",""));if(a.includes("d"))return 864e5*Number(a.replace("d",""));if(a.includes("w"))return 6048e5*Number(a.replace("w",""));if(a.includes("y"))return 31536e6*Number(a.replace("y",""))}if("number"==typeof a)return a}catch(b){console.error("Timer.js: incorrect value provided for time")}return 0}constructor(a,b){this.duration=this.toMs(a),this.options=b||this.options}setDuration(a){this.duration=this.toMs(a)}addDuration(a){this.duration+=this.toMs(a)}setRunningTime(a){this.pauseAmount=this.toMs(a),this.beginTime=this.now()}addRunningTime(a){this.pauseAmount+=this.toMs(a)}runningTime(a){return!0===this.paused?this.formatTime(this.pauseAmount,a):this.formatTime(this.pauseAmount+(this.now()-this.beginTime),a)}timeLeft(a){return this.formatTime(this.duration-this.runningTime(),a)}start(){if(this.paused){if(this.paused=!1,this.beginTime=this.now(),this.pauseBegin){let a=this.pauseBegin,b=this.beginTime;this._timeline.forEach(function(c){c[0]+=b-a}),this.checkEvents()}this.specialEventsRegistry.length&&this.specialEventsRegistry.filter(a=>"resume"===a.type).length&&this.dispatchEvent("resume")}return this}resume(){return this.start()}stop(){if(!0!==this.paused){let a=this.now();this.pauseBegin=a,this.paused=!0,this.pauseAmount+=a-this.beginTime,this.specialEventsRegistry.length&&this.specialEventsRegistry.filter(a=>"pause"===a.type).length&&this.dispatchEvent("pause")}return this}pause(){return this.stop()}reset(){return this.pauseAmount=0,this.paused=!0,this.beginTime=null,this._registerAllEvents(),this.specialEventsRegistry.length&&this.specialEventsRegistry.filter(a=>"reset"===a.type).length&&this.dispatchEvent("reset"),this}addEventListener(a,b){return this._registerEvent(a),this.callbacks.push([a,b])}on(a,b){return this.addEventListener(a,b)}removeEventListener(a){return"string"==typeof a?(this.callbacks=this.callbacks.filter(b=>b[0]!==a),this._timeline=this._timeline.filter(b=>b[1]!==a),this.specialEventsRegistry=this.specialEventsRegistry.filter(b=>b!=a),this):"number"==typeof a?(this.callbacks.splice(a,1),this):void 0}dispatchEvent(b){let a=0;return this.callbacks.forEach(c=>{c[0]==b&&(c[1](),a++)}),a}emit(a){return this.dispatchEvent(a)}_timelineInsert(b,c){let a=0;try{for(;b>=this._timeline[a][0];){if(c===this._timeline[a][1])return this;a++}}catch(d){a=this._timeline.length}this._timeline.splice(a,0,[b,c])}_registerEvent(a){typeof a!==Array&&(a=[a]),a[0].toLowerCase();let b=this.toMs(a[0]);if(b>0){let d=this.now(),c=this.timeLeft()%b+d;c==d&&(c=b),this._timelineInsert(c,a[0])}else specialEventsRegistry.push(a[0]);return this}_unregisterEvent(a){return typeof a===Array&&(a=a[0]),"string"==typeof a&&(a=a.toLowerCase()),this.toMs(a)>0?this._timeline=this._timeline.filter(b=>b[1]!==a):specialEventsRegistry=specialEventsRegistry.filter(b=>b!==a),this}_registerAllEvents(){this._timeline=[],this.callbacks.forEach(a=>{this._registerEvent(a)})}checkEvents(){if(!0!=this.paused){for(;this._timeline.length&&this._timeline[0][0]+this.options.eventPrecision<=this.now();){console.log("event triggered: "+this._timeline[0][1]),this.dispatchEvent(this._timeline[0][1]);let a=this._timeline.shift();this._registerEvent(a[1])}0>=this.timeLeft()&& !1==this.paused&&this.specialEventsRegistry.filter(a=>"end"===a).length&&(this.dispatchEvent("end"),this.pause()),null!==this._currentTimeoutId&&this._timeline.length&&(clearTimeout(this._currentTimeoutId),this._timeline.length&&(this._currentTimeoutId=setTimeout(this.checkEvents.bind(this),this._timeline[0][0]-this.now()-this.options.eventPrecision/2)))}return this}}